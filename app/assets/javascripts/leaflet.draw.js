/*
	Leaflet.draw, a plugin that adds drawing and editing tools to Leaflet powered maps.
	(c) 2012-2013, Jacob Toye, Smartrak

	https://github.com/Leaflet/Leaflet.draw
	http://leafletjs.com
	https://github.com/jacobtoye
*/
!function(){L.drawVersion="0.2.1-dev",L.drawLocal={draw:{toolbar:{actions:{title:"Cancel drawing",text:"Cancel"},buttons:{polyline:"Draw a polyline",polygon:"Draw a polygon",rectangle:"Draw a rectangle",circle:"Draw a circle",marker:"Draw a marker"}},handlers:{circle:{tooltip:{start:"Click and drag to draw circle."}},marker:{tooltip:{start:"Click map to place marker."}},polygon:{tooltip:{start:"Click to start drawing shape.",cont:"Click to continue drawing shape.",end:"Click first point to close this shape."}},polyline:{error:"<strong>Error:</strong> shape edges cannot cross!",tooltip:{start:"Click to start drawing line.",cont:"Click to continue drawing line.",end:"Click last point to finish line."}},rectangle:{tooltip:{start:"Click and drag to draw rectangle."}},simpleshape:{tooltip:{end:"Release mouse to finish drawing."}}}},edit:{toolbar:{actions:{save:{title:"Save changes.",text:"Save"},cancel:{title:"Cancel editing, discards all changes.",text:"Cancel"}},buttons:{edit:"Edit layers",remove:"Delete layers"}},handlers:{edit:{tooltip:{text:"Drag handles, or marker to edit feature.",subtext:"Click cancel to undo changes."}},remove:{tooltip:{text:"Click on a feature to remove"}}}}},L.Edit=L.Edit||{},L.Edit.Poly=L.Handler.extend({options:{icon:new L.DivIcon({iconSize:new L.Point(8,8),className:"leaflet-div-icon leaflet-editing-icon"})},initialize:function(e,t){this._poly=e,L.setOptions(this,t)},addHooks:function(){this._poly._map&&(this._markerGroup||this._initMarkers(),this._poly._map.addLayer(this._markerGroup))},removeHooks:function(){this._poly._map&&(this._poly._map.removeLayer(this._markerGroup),delete this._markerGroup,delete this._markers)},updateMarkers:function(){this._markerGroup.clearLayers(),this._initMarkers()},_initMarkers:function(){this._markerGroup||(this._markerGroup=new L.LayerGroup),this._markers=[];var e,t,i,r,n=this._poly._latlngs;for(e=0,i=n.length;i>e;e++)r=this._createMarker(n[e],e),r.on("click",this._onMarkerClick,this),this._markers.push(r);var a,s;for(e=0,t=i-1;i>e;t=e++)(0!==e||L.Polygon&&this._poly instanceof L.Polygon)&&(a=this._markers[t],s=this._markers[e],this._createMiddleMarker(a,s),this._updatePrevNext(a,s))},_createMarker:function(e,t){var i=new L.Marker(e,{draggable:!0,icon:this.options.icon});return i._origLatLng=e,i._index=t,i.on("drag",this._onMarkerDrag,this),i.on("dragend",this._fireEdit,this),this._markerGroup.addLayer(i),i},_removeMarker:function(e){var t=e._index;this._markerGroup.removeLayer(e),this._markers.splice(t,1),this._poly.spliceLatLngs(t,1),this._updateIndexes(t,-1),e.off("drag",this._onMarkerDrag,this).off("dragend",this._fireEdit,this).off("click",this._onMarkerClick,this)},_fireEdit:function(){this._poly.edited=!0,this._poly.fire("edit")},_onMarkerDrag:function(e){var t=e.target;L.extend(t._origLatLng,t._latlng),t._middleLeft&&t._middleLeft.setLatLng(this._getMiddleLatLng(t._prev,t)),t._middleRight&&t._middleRight.setLatLng(this._getMiddleLatLng(t,t._next)),this._poly.redraw()},_onMarkerClick:function(e){if(!(this._poly._latlngs.length<3)){var t=e.target;this._removeMarker(t),this._updatePrevNext(t._prev,t._next),t._middleLeft&&this._markerGroup.removeLayer(t._middleLeft),t._middleRight&&this._markerGroup.removeLayer(t._middleRight),t._prev&&t._next?this._createMiddleMarker(t._prev,t._next):t._prev?t._next||(t._prev._middleRight=null):t._next._middleLeft=null,this._fireEdit()}},_updateIndexes:function(e,t){this._markerGroup.eachLayer(function(i){i._index>e&&(i._index+=t)})},_createMiddleMarker:function(e,t){var i,r,n,a=this._getMiddleLatLng(e,t),s=this._createMarker(a);s.setOpacity(.6),e._middleRight=t._middleLeft=s,r=function(){var r=t._index;s._index=r,s.off("click",i,this).on("click",this._onMarkerClick,this),a.lat=s.getLatLng().lat,a.lng=s.getLatLng().lng,this._poly.spliceLatLngs(r,0,a),this._markers.splice(r,0,s),s.setOpacity(1),this._updateIndexes(r,1),t._index++,this._updatePrevNext(e,s),this._updatePrevNext(s,t)},n=function(){s.off("dragstart",r,this),s.off("dragend",n,this),this._createMiddleMarker(e,s),this._createMiddleMarker(s,t)},i=function(){r.call(this),n.call(this),this._fireEdit()},s.on("click",i,this).on("dragstart",r,this).on("dragend",n,this),this._markerGroup.addLayer(s)},_updatePrevNext:function(e,t){e&&(e._next=t),t&&(t._prev=e)},_getMiddleLatLng:function(e,t){var i=this._poly._map,r=i.latLngToLayerPoint(e.getLatLng()),n=i.latLngToLayerPoint(t.getLatLng());return i.layerPointToLatLng(r._add(n)._divideBy(2))}}),L.Polyline.addInitHook(function(){this.editing||(L.Edit.Poly&&(this.editing=new L.Edit.Poly(this),this.options.editable&&this.editing.enable()),this.on("add",function(){this.editing&&this.editing.enabled()&&this.editing.addHooks()}),this.on("remove",function(){this.editing&&this.editing.enabled()&&this.editing.removeHooks()}))}),L.Edit=L.Edit||{},L.Edit.SimpleShape=L.Handler.extend({options:{moveIcon:new L.DivIcon({iconSize:new L.Point(8,8),className:"leaflet-div-icon leaflet-editing-icon leaflet-edit-move"}),resizeIcon:new L.DivIcon({iconSize:new L.Point(8,8),className:"leaflet-div-icon leaflet-editing-icon leaflet-edit-resize"})},initialize:function(e,t){this._shape=e,L.Util.setOptions(this,t)},addHooks:function(){this._shape._map&&(this._map=this._shape._map,this._markerGroup||this._initMarkers(),this._map.addLayer(this._markerGroup))},removeHooks:function(){if(this._shape._map){this._unbindMarker(this._moveMarker);for(var e=0,t=this._resizeMarkers.length;t>e;e++)this._unbindMarker(this._resizeMarkers[e]);this._resizeMarkers=null,this._map.removeLayer(this._markerGroup),delete this._markerGroup}this._map=null},updateMarkers:function(){this._markerGroup.clearLayers(),this._initMarkers()},_initMarkers:function(){this._markerGroup||(this._markerGroup=new L.LayerGroup),this._createMoveMarker(),this._createResizeMarker()},_createMoveMarker:function(){},_createResizeMarker:function(){},_createMarker:function(e,t){var i=new L.Marker(e,{draggable:!0,icon:t,zIndexOffset:10});return this._bindMarker(i),this._markerGroup.addLayer(i),i},_bindMarker:function(e){e.on("dragstart",this._onMarkerDragStart,this).on("drag",this._onMarkerDrag,this).on("dragend",this._onMarkerDragEnd,this)},_unbindMarker:function(e){e.off("dragstart",this._onMarkerDragStart,this).off("drag",this._onMarkerDrag,this).off("dragend",this._onMarkerDragEnd,this)},_onMarkerDragStart:function(e){var t=e.target;t.setOpacity(0)},_fireEdit:function(){this._shape.edited=!0,this._shape.fire("edit")},_onMarkerDrag:function(e){var t=e.target,i=t.getLatLng();t===this._moveMarker?this._move(i):this._resize(i),this._shape.redraw()},_onMarkerDragEnd:function(e){var t=e.target;t.setOpacity(1),this._shape.fire("edit"),this._fireEdit()},_move:function(){},_resize:function(){}}),L.Edit=L.Edit||{},L.Edit.Rectangle=L.Edit.SimpleShape.extend({_createMoveMarker:function(){var e=this._shape.getBounds(),t=e.getCenter();this._moveMarker=this._createMarker(t,this.options.moveIcon)},_createResizeMarker:function(){var e=this._getCorners();this._resizeMarkers=[];for(var t=0,i=e.length;i>t;t++)this._resizeMarkers.push(this._createMarker(e[t],this.options.resizeIcon)),this._resizeMarkers[t]._cornerIndex=t},_onMarkerDragStart:function(e){L.Edit.SimpleShape.prototype._onMarkerDragStart.call(this,e);var t=this._getCorners(),i=e.target,r=i._cornerIndex;this._oppositeCorner=t[(r+2)%4],this._toggleCornerMarkers(0,r)},_onMarkerDragEnd:function(e){var t,i,r=e.target;r===this._moveMarker&&(t=this._shape.getBounds(),i=t.getCenter(),r.setLatLng(i)),this._toggleCornerMarkers(1),this._repositionCornerMarkers(),L.Edit.SimpleShape.prototype._onMarkerDragEnd.call(this,e)},_move:function(e){for(var t,i=this._shape.getLatLngs(),r=this._shape.getBounds(),n=r.getCenter(),a=[],s=0,o=i.length;o>s;s++)t=[i[s].lat-n.lat,i[s].lng-n.lng],a.push([e.lat+t[0],e.lng+t[1]]);this._shape.setLatLngs(a),this._repositionCornerMarkers()},_resize:function(e){var t;this._shape.setBounds(L.latLngBounds(e,this._oppositeCorner)),t=this._shape.getBounds(),this._moveMarker.setLatLng(t.getCenter())},_getCorners:function(){var e=this._shape.getBounds(),t=e.getNorthWest(),i=e.getNorthEast(),r=e.getSouthEast(),n=e.getSouthWest();return[t,i,r,n]},_toggleCornerMarkers:function(e){for(var t=0,i=this._resizeMarkers.length;i>t;t++)this._resizeMarkers[t].setOpacity(e)},_repositionCornerMarkers:function(){for(var e=this._getCorners(),t=0,i=this._resizeMarkers.length;i>t;t++)this._resizeMarkers[t].setLatLng(e[t])}}),L.Rectangle.addInitHook(function(){L.Edit.Rectangle&&(this.editing=new L.Edit.Rectangle(this),this.options.editable&&this.editing.enable())}),L.Edit=L.Edit||{},L.Edit.Circle=L.Edit.SimpleShape.extend({_createMoveMarker:function(){var e=this._shape.getLatLng();this._moveMarker=this._createMarker(e,this.options.moveIcon)},_createResizeMarker:function(){var e=this._shape.getLatLng(),t=this._getResizeMarkerPoint(e);this._resizeMarkers=[],this._resizeMarkers.push(this._createMarker(t,this.options.resizeIcon))},_getResizeMarkerPoint:function(e){var t=this._shape._radius*Math.cos(Math.PI/4),i=this._map.project(e);return this._map.unproject([i.x+t,i.y-t])},_move:function(e){var t=this._getResizeMarkerPoint(e);this._resizeMarkers[0].setLatLng(t),this._shape.setLatLng(e)},_resize:function(e){var t=this._moveMarker.getLatLng(),i=t.distanceTo(e);this._shape.setRadius(i)}}),L.Circle.addInitHook(function(){L.Edit.Circle&&(this.editing=new L.Edit.Circle(this),this.options.editable&&this.editing.enable()),this.on("add",function(){this.editing&&this.editing.enabled()&&this.editing.addHooks()}),this.on("remove",function(){this.editing&&this.editing.enabled()&&this.editing.removeHooks()})}),L.LatLngUtil={cloneLatLngs:function(e){for(var t=[],i=0,r=e.length;r>i;i++)t.push(this.cloneLatLng(e[i]));return t},cloneLatLng:function(e){return L.latLng(e.lat,e.lng)}},L.PolygonUtil={geodesicArea:function(e){var t,i,r=e.length,n=0,a=L.LatLng.DEG_TO_RAD;if(r>2){for(var s=0;r>s;s++)t=e[s],i=e[(s+1)%r],n+=(i.lng-t.lng)*a*(2+Math.sin(t.lat*a)+Math.sin(i.lat*a));n=6378137*6378137*n/2}return Math.abs(n)}},L.Util.extend(L.LineUtil,{segmentsIntersect:function(e,t,i,r){return this._checkCounterclockwise(e,i,r)!==this._checkCounterclockwise(t,i,r)&&this._checkCounterclockwise(e,t,i)!==this._checkCounterclockwise(e,t,r)},_checkCounterclockwise:function(e,t,i){return(i.y-e.y)*(t.x-e.x)>(t.y-e.y)*(i.x-e.x)}}),L.Polyline.include({intersects:function(){var e,t,i,r=this._originalPoints,n=r?r.length:0;if(this._tooFewPointsForIntersection())return!1;for(e=n-1;e>=3;e--)if(t=r[e-1],i=r[e],this._lineSegmentsIntersectsRange(t,i,e-2))return!0;return!1},newLatLngIntersects:function(e,t){return this._map?this.newPointIntersects(this._map.latLngToLayerPoint(e),t):!1},newPointIntersects:function(e,t){var i=this._originalPoints,r=i?i.length:0,n=i?i[r-1]:null,a=r-2;return this._tooFewPointsForIntersection(1)?!1:this._lineSegmentsIntersectsRange(n,e,a,t?1:0)},_tooFewPointsForIntersection:function(e){var t=this._originalPoints,i=t?t.length:0;return i+=e||0,!this._originalPoints||3>=i},_lineSegmentsIntersectsRange:function(e,t,i,r){var n,a,s=this._originalPoints;r=r||0;for(var o=i;o>r;o--)if(n=s[o-1],a=s[o],L.LineUtil.segmentsIntersect(e,t,n,a))return!0;return!1}}),L.Polygon.include({intersects:function(){var e,t,i,r,n,a=this._originalPoints;return this._tooFewPointsForIntersection()?!1:(e=L.Polyline.prototype.intersects.call(this))?!0:(t=a.length,i=a[0],r=a[t-1],n=t-2,this._lineSegmentsIntersectsRange(r,i,n,1))}})}(this,document);